<?php

/**
*
* ImageExtra
*
* See README.md for usage instructions.
*
* @author Tabea David <info@justonestep.de>
* @version 0.0.1
* @copyright Copyright (c) 2014
* @see https://github.com/justonestep/processwire-imageextra
* @see http://www.processwire.com
*/

/**
* Class ImageExtra
*/
class ImageExtra extends WireData implements Module, ConfigurableModule {

  /**
   * Retrieves module meta data
   * Implementation of the Module interface
   *
   * @return array
   * @see http://processwire.com/apigen/class-Module.html
   */
  public static function getModuleInfo() {
    return array(
      'title' => 'Image Extra',
      'summary' => '',
      'version' => 1,
      'href' => 'https://github.com/justonestep/processwire-imageextra',
      'singular' => true,
      'autoload' => true,
    );
  }

  /**
   * @field array Default config values
   *
   */
  protected static $defaults = array(
    'captionField' => false,
    'orientationField' => false,
    'orientationValues' => 'left,right',
    'linkField' => false,
    'otherField' => ''
  );

  /**
   * @field array Default config values
   */
  protected static $basics = array(
    'selectedInputfields' => 'InputfieldImage'
  );

  /**
   * Retrieves the list of config input fields
   *
   * Implementation of the ConfigurableModule interface
   *
   * @param array $data The config data
   * @return InputfieldWrapper
   * @see http://processwire.com/apigen/class-ConfigurableModule.html
   */
  public static function getModuleConfigInputfields(array $data) {
    $fields = new InputfieldWrapper();
    $modules = wire('modules');

    // default config values
    $data = array_merge(self::$basics, $data);

    $field = $modules->get('InputfieldAsmSelect');
    $field->attr('value', $data['selectedInputfields']);
    $field->description = 'Select the inputfields where the extra fields should be attached.';
    $field->addOption('', '');
    $field->label = 'Select Image Inputfields';
    $field->attr('name', 'selectedInputfields');
    $field->required = true;

    foreach (wire('modules') as $module) {
      if (preg_match('/^Inputfield/', $module)) {
        $field->addOption($module->name, $module->name);
      }
    }

    $fields->append($field);

    return $fields;
  }

  protected $additionalFields = array();

  /**
   * Initialize the module
   *
   * Implementation of the Module interface
   *
   * ProcessWire calls this when the module is loaded. For 'autoload' modules, this will be called
   * when ProcessWire's API is ready. As a result, this is a good place to attach hooks.
   *
   * @see http://processwire.com/apigen/class-Module.html
   *
   * @param Template $template Template object holding the form's fields.
   *
   */
  public function init() {
  }

  /**
   * Initialize the module
   *
   * Implementation of the Module interface
   *
   * ProcessWire calls this when the module is loaded. For 'autoload' modules, this will be called
   * when ProcessWire's API is ready. As a result, this is a good place to attach hooks.
   *
   * @see http://processwire.com/apigen/class-Module.html
   *
   * @param Template $template Template object holding the form's fields.
   *
   */
  public function ready() {
    $this->addHookAfter('InputfieldImage::getConfigInputfields', $this, 'addExtraFields');
    $this->addHookAfter('InputfieldImage::renderItem', $this, 'renderExtraFields');
    $this->addHookBefore('ProcessField::executeSave', $this, 'checkTableColumns');

    if (wire('page')->template->name === 'admin' && !empty($this->input->get->id) || wire('page')->template->name != 'admin') {
      $this->addCustomMethods();

      if (wire('page')->name === 'field' || !empty($this->additionalFields)) {
        $this->addHookAfter('InputfieldFile::processInput', $this, 'processInputExtra');
        $this->addHookAfter('InputfieldFile::processInputFile', $this, 'processInputFileExtra');
        $this->addHookAfter('InputfieldFile::processInputAddFile', $this, 'processInputAddFileExtra');
        $this->addHookAfter('Fieldtype::loadPageField', $this, 'loadPageFieldExtra');
        $this->addHookAfter('FieldtypeFile::sleepValue', $this, 'sleepExtraValue');
        $this->addHookAfter('FieldtypeFile::wakeupValue', $this, 'wakeupExtraValue');
      }
    }
  }

  public function addCustomMethods() {
    $fieldNames = array();
    if (wire('page')->template->name != 'admin') {
      $fieldNameFields = wire('page')->template->fields->find('inputfieldClass=' . implode('|', $this->selectedInputfields));
      if (count($fieldNameFields)) {

        foreach ($fieldNameFields as $f) {
          $fieldNames[] = $f->name;
        }
      }
    } else {
      if ($this->page->name === 'fields') {
      } elseif (wire('pages')->get($this->input->get->id)->template) {
        $fieldNameFields = wire('pages')->get($this->input->get->id)->template->fields->find('inputfieldClass=' . implode('|', $this->selectedInputfields));
        if (count($fieldNameFields)) {

          foreach ($fieldNameFields as $f) {
            $fieldNames[] = $f->name;
          }
        }
      }
    }

    if (!empty($fieldNames)) {
      foreach ($fieldNames as $fieldName) {
        $fieldConfig = $this->fields->get($fieldName);
        if (!empty($fieldConfig)) {
          $this->getAdditionalInputFields($fieldConfig->data);
        }
      }

      foreach ($this->additionalFields as $current) {
        $this->addHookProperty('Pageimage::' . $current, function($event) { });
        $this->addHook('Pageimage::' . $current, function($event) {
          $event->return = $this->addCustomMethod($event, $event->method);
        });
      }
    }
  }

  private function addCustomMethod(HookEvent $event, $current) {
    $language = $event->arguments(0);
    $value = $event->arguments(1);
    $pagefile = $event->object;

    if (!is_null($value)) {
      return ($language === true) ? $this->setExtra($current, $value, null, $event->object) : $this->setExtra($current, $value, $language, $event->object);
    }

    if ((is_string($language) || is_int($language)) && $this->wire('languages')) {
      // convert named or ID'd languages to Language object
      $language = $this->wire('languages')->get($language);
    }

    if (is_null($language)) {
      // return description for current user language, or inherit from default if not available
      $user = $this->wire('user');
      $value = null;
      // if ($user->language && $user->language->id) $value = parent::get($current . $user->language);
      // if ($user->language && $user->language->id) $value = $pagefile->get($current . $user->language);
      if ($user->language && $user->language->id) $value = $event->object->get($current . $user->language);
      if (empty($value)) {
        // inherit default language value
        // $value = parent::get($current);
        // $value = $pagefile->get($current);
        $value = $event->object->get($current);
      }
    } else if ($language === true) {
      // return JSON string of all languages if applicable
      $languages = $this->wire('languages');
      if ($languages && $languages->count() > 1) {
        // $values = array(0 => parent::get($current));
        // $values = array(0 => $pagefile->get($current));
        $values = array(0 => $event->object->get($current));
        foreach ($languages as $lang) {
          if ($lang->isDefault()) continue;
          // $v = parent::get($current . $lang);
          // $v = $pagefile->get($current . $lang);
          $v = $event->object->get($current . $lang);
          if (empty($v)) continue;
          $values[$lang->id] = $v;
        }
        $flags = defined("JSON_UNESCAPED_UNICODE") ? JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES : 0; // more fulltext friendly
        $value = json_encode($values, $flags);
      } else {
        // no languages present so just return string with description
        // $value = parent::get($current);
        // $value = $pagefile->get($current);
        $value = $event->object->get($current);
      }

    } else if (is_object($language) && $language->id) {
      // return description for specific language or blank if not available
      // if ($language->isDefault()) $value = parent::get($current);
      // if ($language->isDefault()) $value = $pagefile->get($current);
      if ($language->isDefault()) $value = $event->object->get($current);
        // else $value = parent::get($current . $language);
        // else $value = $pagefile->get($current . $language);
        else $value = $event->object->get($current . $language);
    }

    // we only return strings, so return blank rather than null
    if (is_null($value)) $value = '';

    return $value;
  }


	/**
	 * Set the parent of this Inputfield
	 *
	 * @param InputfieldWrapper $parent
	 * @return $this
	 *
	 */
	public function setParent(InputfieldWrapper $parent) {
		$this->parent = $parent;
		return $this;
	}


	/**
	 * Set a description, optionally parsing JSON language-specific descriptions to separate properties
	 *
	 * @param string $name
	 * @param string $value
	 * @param Page|Language Langage to set it for. Omit to determine automatically.
	 * @return this
	 *
	 */
	protected function setExtra($name, $value, Page $language = null, $pagefile) {
    if (!is_null($language) && $language->id) {
      if (!$language->isDefault()) $name .= $language->id;
      $value = $this->wire('sanitizer')->textarea($value);
      // @todo: pah. this does not work
      // parent::set($name, $this->wire('sanitizer')->textarea($value));
      $pagefile->set($name, $this->wire('sanitizer')->textarea($value));
      return $this;
    }

    // check if it contains JSON?
    $first = substr($value, 0, 1);
    $last = substr($value, -1);
    if(($first == '{' && $last == '}') || ($first == '[' && $last == ']')) {
      $values = json_decode($value, true);
    } else {
      $values = array();
    }

    if ($values && count($values)) {
      $n = 0;
      foreach ($values as $id => $v) {
        // first item is always default language. this ensures that this will still
        // work even if language support is later uninstalled.
        $item = $n > 0 ? $name . $id : $name;
        $value = $this->wire('sanitizer')->textarea($v);
        $pagefile->set($item, $value);
        // parent::set($item, $value);
        $n++;
      }
    } else {
      // no JSON values so assume regular language
      $languages = $this->wire('languages');
      $language = $this->wire('user')->language;
      $value = $this->wire('sanitizer')->textarea($value);

      if($languages && $language && !$language->isDefault()) {
        // parent::set($name . $language, $value);
        $pagefile->set($name . $language, $value);
      } else {
        // parent::set($name, $value);
        $pagefile->set($name, $value);
      }
    }

    return $pagefile;
  }

  public function loadPageFieldExtra(HookEvent $event) {
    $page = $event->arguments(0);
    $field = $event->arguments(1);

    if (!$page->id || !$field->id) return null;

    $if = array();
    foreach ($this->selectedInputfields as $inputfield) {
      $if[] = $field->inputfieldClass === $inputfield;
    }

    if (implode(' || ', $if)) {
      $database = $this->wire('database');
      $isMulti = $field->type instanceof FieldtypeMulti;
      $page_id = (int) $page->id;
      $table = $database->escapeTable($field->table);

      $chkcol = $this->db->query("SHOW COLUMNS FROM `$table`");
      $columns = array();
      while ($row = mysqli_fetch_assoc($chkcol)) {
        $columns[] = $row['Field'];
      }

      $query = new DatabaseQuerySelect();
      $tmpAddFields = array();
      $count = 0;
      foreach ($this->additionalFields as $add) {
        if (in_array($add, $columns)) {
          $query->select("field_{$field->name}.$add AS `" . $field->name . "__$add`");
          $tmpAddFields[] = $add;
          $count++;
        }
      }

      if ($count === 0 || empty($tmpAddFields)) return null;

      $query->where("$table.pages_id='$page_id'");
      $query->from($table);
      if ($isMulti) $query->orderby('sort');

      $value = null;
      $stmt = $query->execute();
      $result = $stmt->errorCode() > 0 ? false : true;

      $fieldName = $database->escapeCol($field->name);

      if (!$result) return $value;

      $values = array();
      while($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $value = array();
        foreach ($tmpAddFields as $add) {
          $key = $fieldName . '__' . $add;
          $value[$add] = $row[$key];
        }

        // if there is just one 'data' field here, then don't bother with the array, just make data the value
        if (count($value) == 1 && isset($value['data'])) $value = $value['data'];

        if (!$isMulti) break;
        $values[] = $value;
      }

      $stmt->closeCursor();

      if ($isMulti && count($values)) $value = $values;

      $return = array();
      if (!empty($event->return)) {

        foreach ($event->return as $key => $r) {
          $return[] = $r + $value[$key];
        }

        $event->return = $return;
      }
    }
  }

  public function sleepExtraValue(HookEvent $event) {
    // no image upload? the reason could be here
    $page = $event->arguments(0);
    $field = $event->arguments(1);
    $value = $event->arguments(2);
    $table = $this->db->escapeTable($field->table);

    $chkcol = $this->db->query("SHOW COLUMNS FROM `$table`");
    $columns = array();
    while ($row = mysqli_fetch_assoc($chkcol)) {
      $columns[] = $row['Field'];
    }

    $tmp = array();
    foreach ($value as $pagefile) {
      foreach ($this->additionalFields as $add) {
        if (in_array($add, $columns)) {
          if (!is_null($pagefile->$add)) {
            $tmp[][$add] = $pagefile->$add(true);
          }
        }
      }
    }

    if (!empty($tmp)) {
      $sleepValue = array();
      foreach ($event->return as $key => $e) {
        $sleepValue[] = $e + $tmp[$key];
      }

      $event->return = $sleepValue;
    }

  }

  public function wakeupExtraValue(HookEvent $event) {
    $page = $event->arguments(0);
    $field = $event->arguments(1);
    $value = $event->arguments(2);

    $table = $this->db->escapeTable($field->table);

    $chkcol = $this->db->query("SHOW COLUMNS FROM `$table`");
    $columns = array();
    while ($row = mysqli_fetch_assoc($chkcol)) {
      $columns[] = $row['Field'];
    }

    if (!is_array($value) || array_key_exists('data', $value)) $value = array($value);

    $pagefiles = array();
    foreach ($event->return as $pagefile) {
      $pagefiles[] = $pagefile;
    }

    foreach ($value as $key => $v) {
      if (empty($v['data'])) continue;

      foreach ($this->additionalFields as $add) {
        if (in_array($add, $columns)) {
          $pagefile = $pagefiles[$key];
          $pagefile->$add(true, $v[$add]);
        }
      }
    }
  }

  public function processInputExtra(HookEvent $event) {
    $input = $event->arguments(0);
    // var_dump($input);
  }

  public function processInputAddFileExtra(HookEvent $event) {
    $filename = $event->arguments(0);
    $value = $event->object->attributes['value'];
    $total = count($value);

    // var_dump($filename);
    // var_dump($total);
    // var_dump($value);

    $item = $value->last();
    // var_dump($filename);
    // $item->data['caption'] = '';
    // $item->object->attributes['data']
    $item->set('caption', '');
    // var_dump($item->data);
    // var_dump($item->data);
    //
    // try {
    //   $item->caption = '';
    // } catch (Exception $e) {
    //   throw new WireException($e->getMessage());
    // }

    // exit;
    // foreach ($value as $key => $val) {
    //   var_dump($val->description);
    // }
    //
    // $caption = '';
    //
    // var_dump($total);
    // exit;
  }


  public function processInputFileExtra(HookEvent $event) {
    $input = $event->arguments(0);
    $pagefile = $event->arguments(1);
    $n = $event->arguments(2);
    $name = $event->object->name;
    $id = $name . '_' . $pagefile->hash;
    $changed = false;
    $languages = $this->noLang ? null : $this->wire('languages');

    foreach ($this->additionalFields as $key) {
      if(isset($input[$key . '_' . $id])) {
        $value = trim($input[$key . '_' . $id]);
        if($value != $pagefile->$key) {
          $pagefile->$key = $value;
          $changed = true;
        }
      }
    }

    // multi-language additional fields
    if ($languages) foreach($languages as $language) {
      foreach ($this->additionalFields as $add) {
        $key = $language->isDefault() ? $add . '_' . $id : "$add{$language->id}_$id";
        if(!isset($input[$key])) continue;
        $value = trim($input[$key]);
        if ($value != $pagefile->{$add}($language)) {
          $pagefile->{$add}($language, $value);
          $changed = true;
        }
      }
    }

    $event->return = $changed;
  }


  public function addExtraFields(HookEvent $event) {
    $if = array();
    foreach ($this->selectedInputfields as $inputfield) {
      $if[] = $event->object instanceof $inputfield;
    }

    if (implode(' || ', $if)) {
      $data = $this->mergeData($event->object->name);

      $fieldset = $this->modules->get('InputfieldFieldset');
      $fieldset->label = $this->_('Image Extra Fields');
      $fieldset->collapsed = Inputfield::collapsedYes;
      $fieldset->description = $this->_('Here you can add additional image fields.'); // Max image dimensions description

      // move description fields
      foreach ($event->return->children as $field) {
        if (in_array($field->name, array('descriptionRows', 'noLang'))) {
          $event->return->children->remove($field);
          $fieldset->add($field);
        }
      }

      // assign fields
      foreach ($this->getExtraFields($data) as $name => $s) {
        // no orientation field - no orientation values needed
        if ($name === 'orientationValues' && (int)$data['orientationField']== 0) {
          continue;
        }

        // add orientation field, reduce column width
        if ($name === 'orientationField' && (int)$data['orientationField'] > 0) {
          $s['columnWidth'] = 25;
        }

        $field = $this->modules->get($s['type']);
        $field->name = $name;
        $field->value = $data[$name];

        foreach ($s as $key => $val) {
          if ($key != 'type') {
            $field->{$key} = $val;
          }
        }

        $fieldset->add($field);
      }

      $event->return->children->add($fieldset);
    }
  }

  public function getExtraFields($data) {
    return array(
      'captionField' => array(
        'type' => 'InputfieldCheckbox',
        'label' => 'Add caption field?',
        'description' => 'Enable Caption Input Field' . PHP_EOL . '(activate the checkbox to enable field `caption`)',
        'checked' => empty($data['captionField']) ? '' : 'checked',
        'columnWidth' => 50
      ),
      'orientationField' => array(
        'type' => 'InputfieldCheckbox',
        'label' => 'Add orientation field?',
        'description' => 'Enable Image Orientation Select Field' . PHP_EOL . '(activate the checkbox to enable field `orientation`)',
        'checked' => empty($data['orientationField']) ? '' : 'checked',
        'columnWidth' => 50
      ),
      'orientationValues' => array(
        'type' => 'InputfieldText',
        'label' => 'Enter image orientation values',
        'description' => 'Values for Image Orientation Select Field' . PHP_EOL . '(comma-separated list)',
        'value' => $data['orientationValues'],
        'size' => 45,
        'columnWidth' => 25
      ),
      'linkField' => array(
        'type' => 'InputfieldCheckbox',
        'label' => 'Add internal link field?',
        'description' => 'Enable Choose-Link Field' . PHP_EOL . '(activate the checkbox to enable field `link`)',
        'checked' => empty($data['linkField']) ? '' : 'checked',
        'columnWidth' => 50
      ),
      'otherField' => array(
        'type' => 'InputfieldText',
        'label' => 'Add other text input fields?',
        'description' => 'Add other fields as simple inputs' . PHP_EOL . '(comma-separated list)',
        'value' => $data['otherField'],
        'size' => 80,
        'columnWidth' => 50
      ),
    );
  }

  private function mergeData($fieldName) {
    $fieldConfig = $this->fields->get($fieldName)->data;
    return array_merge(self::$defaults, $fieldConfig);
  }

  private function getAdditionalInputFields($data) {
    if (isset($data['captionField'])) {
      if ($data['captionField'] > 0) {
        $this->additionalFields['caption'] = 'caption';
      }
    }

    if (isset($data['otherField'])) {
      if (!empty($data['otherField'])) {
        $others = preg_replace('/\s+/', '', $data['otherField']);
        $others = str_replace(';', ',', $others);

        foreach (explode(',', $others) as $other) {
          $this->additionalFields[$other] = $other;
        }
      }
    }
  }

  public function renderExtraFields(HookEvent $event) {
    $pagefile = $event->arguments[0];
    $id = $event->arguments[1];
    $n = $event->arguments[2];
    $out = $event->return;
    $outAdditional = '';

    $table = $this->db->escapeTable('field_' . $event->object->name);
    $chkcol = $this->db->query("SHOW COLUMNS FROM `$table`");
    $columns = array();
    while ($row = mysqli_fetch_assoc($chkcol)) {
      $columns[] = $row['Field'];
    }


    $data = $this->mergeData($event->object->name);

    if (!empty($this->additionalFields)) {
      foreach ($this->additionalFields as $field) {
        if (in_array($field, $columns)) {
          $outAdditional .= $this->renderInputItemField($pagefile, $id, $n, $field);
        }
      }
    }

    if ((int)$data['orientationField'] > 0 && !empty($data['orientationValues'])) {
      $outAdditional .= $this->renderSelectItemField($pagefile, $id, $n, 'orientation', $data);
    }

    if ((int)$data['linkField'] > 0) {
      $outAdditional .= $this->renderPageItemField($pagefile, $id, $n, 'orientation');
    }

    $splitOut = preg_split("/[\t]+/", $out);
    $position = count($splitOut) - 2;

    // add label for description field
    $replaceLabel = "<label for='description_{$event->object->name}_{$id}' class='detail'>Description</label>";
    $splitOut[$position - 1] = preg_replace('/<label\b[^>]*>(.*?)<\/label>/', $replaceLabel, $splitOut[$position - 1]);
    $splitOut[$position - 1] = str_replace('InputfieldFileDescription', 'InputfieldFileDescription2', $splitOut[$position - 1]);
    $splitOut[$position - 1] = str_replace('input', 'input class="InputfieldMaxWidth"', $splitOut[$position - 1]);

    array_splice($splitOut, $position, 0, $outAdditional);

    $event->return = implode('', $splitOut);
  }

  public function checkTableColumns(HookEvent $event) {
    $columns = array();
    foreach (self::$defaults as $add => $default) {
      if ($this->input->post->{$add}) {
        if (preg_match('/(.*?)Field$/', $add)) {
          if ($add !== 'otherField') {
            $columns[] = preg_replace('/Field$/', '', $add);
          } else {
            $others = preg_replace('/\s+/', '', $this->input->post->{$add});
            $others = str_replace(';', ',', $others);
            foreach (explode(',', $others) as $field) {
              $columns[] = $field;
            }
          }
        }
      }
    }

    $db = wire('database');
    $table = $db->escapeTable('field_' . $this->input->post->name);
    $updated = false;

    if (!empty($columns)) {
      foreach ($columns as $col) {
        $sql = "SHOW COLUMNS FROM $table LIKE '$col'";

        try {
          $query = $db->prepare($sql);
          $query->execute();
          $numRows = (int) $query->rowCount();
          $query->closeCursor();
        } catch(Exception $e) {
          $this->errors($e->getMessage(), Notice::log);
        }

        if (empty($numRows)) {
          $updated = true;
          $addColumn = "ALTER TABLE `{$table}` ADD `{$col}` text NOT NULL";

          try {
            $db->exec($addColumn);
            $this->message("Added column '{$col}' for '{$table}'", Notice::log);
          } catch(Exception $e) {
            $this->errors($e->getMessage(), Notice::log);
          }
        }
      }

      if ($updated) {
        try {
          $date = date('Y-m-d H:i:s');
          $query = $db->prepare("UPDATE `$table` SET created=:created, modified=:modified");
          $query->bindValue(":created", $date);
          $query->bindValue(":modified", $date);
          $query->execute();
          $this->message("Updated created/modified for '{$table}'", Notice::log);
        } catch(Exception $e) {
          $this->errors($e->getMessage(), Notice::log);
        }
      }
    }
  }

  protected function renderInputItemField(Pagefile $pagefile, $id, $n, $current) {
    $out = '';
    $tabs = '';
    static $hasLangTabs = null;

    $userLanguage = $this->wire('user')->language;
    $languages = $this->noLang ? null : $this->wire('languages');

    if (!$userLanguage || !$languages || $languages->count() < 2) {
      $numLanguages = 0;
      $languages = array(null);
    } else {
      $numLanguages = $languages->count();
      if (is_null($hasLangTabs)) $hasLangTabs = $this->wire('modules')->isInstalled('LanguageTabs');
    }

    foreach ($languages as $language) {
      $fieldName = $current . '_' . $id;
      $fieldLabel = $this->_(ucfirst($current));
      $labelClass = "detail";

      if ($language) {
        if (!$language->isDefault()) $fieldName = $current . $language->id . '_' . $id;
        $tabID = "langTab_{$id}__$language";
        $tabs .= "<li><a href='#$tabID'>" . $language->get('title|name') . "</a></li>";
        $out .= "<div class='InputfieldFile" . ucfirst($current) . " LanguageSupport' data-language='$language' id='$tabID'>"; // open wrapper
      } else {
        $out .= "<div class='InputfieldFile" . ucfirst($current) . "'>"; // open wrapper
      }

      $out .= "<label for='$fieldName' class='$labelClass'>$fieldLabel</label>";
      $value = $this->wire('sanitizer')->entities($pagefile->{$current}($language));
      $out .= "<input type='text' name='$fieldName' class='InputfieldMaxWidth' id='$fieldName' value='$value' />";
      $out .= "</div>"; // close wrapper
    }

    if ($numLanguages && $hasLangTabs) {
      $ajax = $this->wire('config')->ajax;
      $out = "<div class='hasLangTabs langTabsContainer'><div class='langTabs'><ul>$tabs</ul>$out</div></div>";
      if ($ajax) $out .= "<script>setupLanguageTabs($('#wrap_" . $id . "'));</script>";
    }

    if ($this->useTags) {
      $tags = $this->wire('sanitizer')->entities($pagefile->tags);
      $out .= "<span class='InputfieldFileTags'>" .
        "<label for='tags_$id' class='detail'>{$this->tagsFieldLabel}</label>" .
        "<input type='text' name='tags_$id' id='tags_$id' value='$tags' />" .
        "</span>";
    }

    return $out;
  }


  protected function renderSelectItemField(Pagefile $pagefile, $id, $n, $current, $data) {
    $fieldName = $current . '_' . $id;

    $options = '';
    foreach (explode(',', preg_replace('/\s+/', '', $data['orientationValues'])) as $option) {
      // @todo: get and mark selected
      // $selected = $params['name'] === $val ? 'selected' : '';
      $selected = '';
      $options .= "<option value='$option' $selected>$option</option>";
    }

    $out = "<hr>" .
      "<div class='InputfieldContent'>" .
      "<label for='$fieldName'>" . ucfirst($current) . "</label>" .
      "<select name='select_$fieldName' size='1'>" . $options . "</select>" .
      "</div>";

    return $out;
  }

  protected function renderPageItemField(Pagefile $pagefile, $id, $n, $current) {
    $field = $this->modules->get('InputfieldPageListSelect');
    $field->setAttribute('name+id', $current);
    $field->startLabel = $this->_('Choose Page Link');
    // @todo: add value
    // $field->attr('value', (int) $this->parent_id);

    return "<hr><label>{$field->startLabel}</label>" . $field->render();
  }

}
